<!DOCTYPE html>
<html lang="pt-br">
<meta charset="UTF-8">
<title>Du Lago</title>
<meta name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>
<script src="dist/js/villa.min.js"></script>
<link rel="stylesheet" href="dist/css/villa.min.css"/>
<!--[if lt IE 9]>
<link rel="stylesheet" type="text/css" href="dist/css/material-colors.css"/>
<link rel="stylesheet" type="text/css" href="dist/css/villa-cross.min.css"/>
<script src="dist/js/html5shiv.js"></script>
<script src="dist/js/html5shiv-printshiv.js"></script>
<script src="dist/js/classList.min.js"></script>
<![endif]-->

<style></style>

<body>

<h1>Gerenciador de pedidos</h1>

<label for="consumerName">Cidad√£o:</label>
<input type="text" id="consumerName">

<label for="orderCharge">Troco:</label>
<input type="number" id="orderCharge" min="0.01" step="0.01" max="2500" value="0.00">

<div class="ItemList">
  <button class="Item" data-item-name="P" data-item-price="8.00">Add a P item</button>
  <button class="Item" data-item-name="M" data-item-price="9.00">Add a M item</button>
  <button class="Item" data-item-name="G" data-item-price="11.00">Add a G item</button>
  <button class="Item" data-item-name="F" data-item-price="145.00">Add a F item</button>
</div>
<button id="print">Print</button>
<button id="cut">Cut the paper</button>
<button id="clear">Clear the current order</button>

<script src="dist/js/socket.io.js"></script>

<script>

  class Order {

    constructor() {

      this.consumerName = ' ';
      this.items = {};
      this.priceAmount = 0.00;
      this.orderChange = 0.00;

    }

    pushItem(item) {

      if (!!this.items[item.itemName])
        this.items[item.itemName].quantity++;
      else
        this.items[item.itemName] = item;

      this.updatePriceAmount();

    }

    getItemsArray() {

      return Object.values(this.items);

    }

    updatePriceAmount() {

      let priceAmount = 0.00;

      Object.values(this.items).forEach(item => {

        priceAmount += item.itemPrice * item.quantity;

      });

      this.priceAmount = priceAmount.toFixed(2);

    }

    setConsumerName(consumerName) {

      this.consumerName = consumerName;

      if (!this.consumerName.length)
        this.consumerName = ' ';

    }

    setOrderChange(orderChange) {

      this.orderChange = parseFloat(orderChange).toFixed(2);

    }

    clear() {
      this.consumerName = ' ';
      this.items = {};
      this.priceAmount = 0.00;
      this.orderChange = 0.00;
    }

  }

</script>

<script>

  const order = new Order();

  const items = document.querySelectorAll('.Item');
  items.forEach(item => {
    item.addEventListener('click', () => {
      order.pushItem({
        itemName: item.dataset.itemName,
        itemPrice: item.dataset.itemPrice,
        quantity: 1
      });
    });
  });

  const consumerNameElement = document.getElementById('consumerName');
  consumerNameElement.addEventListener('input', () => {
    order.setConsumerName(consumerNameElement.value);
  });

  const orderChargeElement = document.getElementById('orderCharge');
  orderChargeElement.addEventListener('input', () => {
    order.setOrderChange(orderChargeElement.value);
  });

  document.getElementById('print').addEventListener('click', () => {
    socket.emit('print order', order);
  });

  document.getElementById('cut').addEventListener('click', () => {
    socket.emit('cut paper', true);
  });

  document.getElementById('clear').addEventListener('click', () => {
    order.clear();
  });

</script>

<script>

  const socket = io.connect('http://192.168.1.4:3000');
  socket.on('connect', () => {
    socket.emit('hello', new Date());
  });

</script>

</body>

</html>